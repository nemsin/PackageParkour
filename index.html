<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Package Parkour</title>

        <script src="node_modules/phaser-ce/build/phaser.js"></script>

        <!-- Levels -->
        <script src="lvlTemplate.js"></script>
    </head>
    <body>

    <script type="text/javascript">

        var game;
        var triggerIndex;

        // Groups
        var grounds;
        var levers = [];
        var plates = [];
        var obstacles = [];

    window.onload = function() {

        game = new Phaser.Game(
            1200,
            600,
            Phaser.AUTO,
            '',
            { preload: preload, create: create, update: update, render: render }
        );

        var player;
        var package;
        var courser;
        var rain;

        function preload ()
        {
            //Background
            game.load.image('skybox', 'assets/skybox.png');
            game.load.image('ground', 'assets/ground.png');

            // Triggers
            game.load.image('lever', 'assets/lever.png');
            game.load.image('plate', 'assets/plate.png');

            // Moveable
            game.load.image('player', 'assets/player.png');
            game.load.image('package', 'assets/package.png');

            // Rain
            game.load.image('rain', 'assets/rain.png');
        }

        function create ()
        {
            game.physics.startSystem(Phaser.Physics.ARCADE);

            // create world bounds
            game.world.setBounds(0, 0, 2500, 600);

            // Sky
            var skybox = game.add.sprite(0, 0, 'skybox');

            // Rain
            rain();

            // Ground
            grounds = game.add.group();
            grounds.enableBody = true;
            buildWorld();
            var ground = grounds.create(0, 550, 'ground');
            ground.body.immovable = true;


            player = game.add.sprite(0, 500, 'player');
            package = game.add.sprite(20, 500, 'package');
            courser = game.input.keyboard.createCursorKeys();

            game.physics.enable(player, Phaser.Physics.ARCADE);
            player.enableBody = true;
            player.body.collideWorldBounds = true;
            player.body.bounce.setTo(0.25, 0.25);
            player.body.gravity.y = 500;

            game.physics.enable(package, Phaser.Physics.ARCADE);
            package.enableBody = true;
            package.body.collideWorldBounds = true;
            package.body.bounce.setTo(1, 0.1);
            package.body.gravity.y = 500;

            for (var i = 0; i < obstacles.length; i++)
                obstacles[i][0].body.immovable = true;

            for (var i = 0; i < levers.length; i++)
                game.physics.enable(levers[i][0], Phaser.Physics.ARCADE);

            for (var i = 0; i < plates.length; i++)
                game.physics.enable(plates[i][0], Phaser.Physics.ARCADE);


            game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);
            game.input.keyboard.addKeyCapture([ Phaser.Keyboard.R ]);

            game.camera.follow(player);
        }
        //-------------------------------------------------------------------------------------
        function update ()
        {
            var collision = game.physics.arcade.collide(player, grounds);
            var packCol = game.physics.arcade.collide(player, package);
            var packCol2 = game.physics.arcade.collide(package, grounds);

            //Player Movement
            player.body.move = false;
            if (courser.left.isDown)
                player.body.velocity.x = -100;
            else if (courser.right.isDown)
                player.body.velocity.x = 100;
            else
                player.body.velocity.x = 0;

            // player jumping
            if (courser.up.isDown && player.body.touching.down && (collision || packCol))
                player.body.velocity.y = -250;

            // package slowing down on ground
            if (package.body.velocity.x < 0  && package.body.touching.down && packCol2)
                package.body.velocity.x += 2.5;
            else if (package.body.velocity.x > 0  && package.body.touching.down && packCol2)
                package.body.velocity.x -= 2.5;

            // package throw
            if (Phaser.Math.distance(player.x, player.y, package.x, package.y) <= 42 && player.body.touching.down && collision && !packCol && game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR))
            {
                var mod;
                if (player.x - package.x > 0)
                    mod = -1;
                else
                    mod = 1;

                package.body.velocity.x = mod * 150;
                package.body.velocity.y = -300;
            }

            // Rain
            rain.forEach(checkRain, this, true);

            // Triggers
            for (var i = 0; i < levers.length; i++)
            {
                triggerIndex = i;
                game.physics.arcade.overlap(levers[i][0], player, leverHandler, null, this);
            }

            for (var i = 0; i < plates.length; i++)
            {
                triggerIndex = i;
                game.physics.arcade.overlap(plates[i][0], package, plateHandler, null, this);
            }

            liftObstacle();

            // Reset
            if (game.input.keyboard.isDown(Phaser.Keyboard.R))
                lvlFinished();

            // Completion Detection

        }

        function render()
        {
            game.debug.text("Press 'R' to restart", 32, 32);
        }

        function rain()
        {
            rain = game.add.group();
            game.time.events.loop(50, createSprite, this);
        }

        function createSprite()
        {
            var drop = rain.create(game.world.randomX, 0, 'rain');
            game.physics.enable(drop, Phaser.Physics.ARCADE);
            drop.enableBody = true;
            drop.body.velocity.y = 300;
            drop.body.velocity.x = -25;
        }

        function checkRain(drop)
        {
            if (drop.y > game.height)
                rain.remove(drop, true);
            else if (drop.x > game.width)
                rain.remove(drop, true);
            else if (drop.x < 0)
                rain.remove(drop, true);
        }

    };

    </script>

    </body>
</html>
